#!/bin/bash
# Pre-commit hook to automatically update version numbers
# This hook updates the version in the .csproj file and MainViewModel.cs
# before each commit


# Get the current date in YYYYMMDD format
TODAY=$(date +%Y%m%d)

# Path to the .csproj file
CSPROJ_FILE="Ductilator_Cross_Platform.csproj"
VIEWMODEL_FILE="ViewModels/MainViewModel.cs"


# Function to extract current version
get_current_version() {
    grep -m 1 '<Version>' "$CSPROJ_FILE" | sed -E 's/.*<Version>([^<]+)<\/Version>.*/\1/'
}


# Function to extract version components (YYYYMMDD.###)
extract_version_components() {
    local version=$1
    local datepart=$(echo "$version" | cut -d. -f1)
    local revision=$(echo "$version" | cut -d. -f2)
    echo "$datepart:$revision"
}


# Function to increment revision number (ACVP protocol)
increment_revision() {
    local components=$1
    local datepart=$(echo "$components" | cut -d: -f1)
    local revision=$(echo "$components" | cut -d: -f2)
    if [ "$datepart" = "$TODAY" ]; then
        revision=$((10#$revision + 1))
    else
        revision=1
    fi
    revision=$(printf "%03d" "$revision")
    echo "$TODAY.$revision"
}


# Get current version and calculate new version
CURRENT_VERSION=$(get_current_version)
COMPONENTS=$(extract_version_components "$CURRENT_VERSION")
NEW_VERSION=$(increment_revision "$COMPONENTS")


# Only update if version has changed
if [ "$CURRENT_VERSION" != "$NEW_VERSION" ]; then
    # Update .csproj file
    sed -i '' "s/<Version>.*<\/Version>/<Version>$NEW_VERSION<\/Version>/g" "$CSPROJ_FILE"
    # AssemblyVersion and FileVersion must be valid 4-part integers for .NET
    sed -i '' "s/<AssemblyVersion>.*<\/AssemblyVersion>/<AssemblyVersion>1.0.0.0<\/AssemblyVersion>/g" "$CSPROJ_FILE"
    sed -i '' "s/<FileVersion>.*<\/FileVersion>/<FileVersion>1.0.0.0<\/FileVersion>/g" "$CSPROJ_FILE"
    
    # Update MainViewModel.cs - extract just the version part for display
    sed -i '' "s/_versionInfo = \"Version: .*\";/_versionInfo = \"Version: $NEW_VERSION\";/g" "$VIEWMODEL_FILE"
    
    # Stage the updated files
    git add "$CSPROJ_FILE" "$VIEWMODEL_FILE"
    
    echo "âœ“ Version updated from $CURRENT_VERSION to $NEW_VERSION"
fi

exit 0